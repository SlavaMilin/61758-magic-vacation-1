name: publish to gh-pages

on: [pull_request]

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Build project
      run: |
        npm install
        npm run build
    
    - name: Commit files
      run: |
        git config --local user.email "help@htmlacademy.ru"
        git config --local user.name "keksobot"
        git config --local pull.rebase false
        PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
        if $( git pull origin gh-pages --allow-unrelated-histories ); then
          git checkout gh-pages
        else
          git checkout --orphan gh-pages
        fi
        if [[ -e "$PR_NUMBER" ]]; then
          rm -rf "$PR_NUMBER"
        fi  
        mv build "$PR_NUMBER"
        echo $(git rev-parse --abbrev-ref HEAD)
        git add "$PR_NUMBER"/
        git status
        git commit --allow-empty -m ":heavy_check_mark: Сборка ${{ github.repository }}#"$PR_NUMBER""
    
    - name: Push changes
      run: |
        git push origin gh-pages
